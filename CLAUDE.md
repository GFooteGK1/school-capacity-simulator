# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

School Capacity Simulator - A Vite-based single-page application that overlays human figures on Matterport 3D scans for occupancy visualization and capacity planning. Users can place figures individually or in bulk zones, with realistic school population distributions. Figures are 3D-anchored via the Matterport Embed SDK and track with camera movement.

## Development Commands

```bash
# Development server (opens at localhost:3000)
npm install
npm run dev

# Production build
npm run build       # Outputs to dist/
npm run preview     # Preview production build
```

## Environment Configuration

Required environment variables in `.env`:
- `VITE_MATTERPORT_SDK_KEY` - Matterport SDK key from developer portal
- `VITE_MATTERPORT_MODEL_SID` - Model ID from Matterport scan URL (e.g., `hvvUfPkLBME`)

Users can also switch models at runtime via the sidebar "Load Scan" input.

## Architecture

### Core Module Structure

**main.js** - Primary application logic:
- State management (people array, placement modes, figure settings)
- Matterport iframe initialization
- Event handling for bulk/single placement
- Zone drawing system using HTML5 canvas
- Figure rendering and CRUD operations
- LocalStorage persistence
- Export functionality

**people-figures.js** - SVG figure generation:
- Three render modes: silhouettes (default), icons, dots
- Multiple pose variations (standing, walking, sitting)
- Role-based color schemes (8 roles: Teacher, Student, Admin, etc.)
- Natural variation through random pose/flip selection

**index.html** - Single-page structure with:
- Matterport iframe viewport
- Overlay canvas for zone drawing
- Figures layer for percentage-positioned SVG elements
- Side panel with controls

### Key Architectural Patterns

**Percentage-Based Positioning**
- Figures use `left: X%` and `top: Y%` positioning relative to viewport
- Positions are viewport-relative, not absolute pixels
- This creates "sticky" positioning where figures stay anchored to the Matterport view
- Users should set their view (dollhouse/floorplan) BEFORE placing people

**Zone Drawing System (Bulk Placement)**
- Canvas overlay (`#zoneCanvas`) for drawing rectangular zones
- User drags to define area ‚Üí people scatter within that zone
- Uses gaussian distribution (`jitteredRandom()` with Box-Muller transform) for natural clustering toward zone center
- Zones are converted to percentage coordinates for viewport-relative placement

**Mixed Mode Distribution**
- When role is "Mixed", uses weighted random distribution:
  - 50% Students, 15% Teachers, 5% Admin, 10% Staff, 10% Visitors, 10% Parents
- Implemented via `weightedRandomRole()` with cumulative probability

**State Persistence**
- All state saved to localStorage: people array, figure style, figure size, capacity limit
- Uses keys: `pp_people`, `pp_nextId`, `pp_limit`, `pp_style`, `pp_size`
- Auto-loads on init

### Placement Modes

Three modes controlled by `placementMode` state:
1. **null** - Default, no active placement
2. **'bulk'** - User draws rectangle zone, people scatter inside using gaussian distribution
3. **'single'** - User clicks once to place individual named person

### Figure Rendering

- Figures are rendered as absolutely-positioned divs in `#figuresLayer`
- Each contains inline SVG generated by `people-figures.js`
- Right-click on any figure to remove it
- Size controlled by slider (16-80px)
- Three styles toggle different SVG generators

### Role System

8 predefined roles with unique colors and emoji icons:
- Teacher üìö, Student üéí, Admin üíº, Visitor üëã, Staff üîß, Parent üë®‚Äçüë©‚Äçüëß, Custodian üßπ, Other üë§
- Colors defined in `FIGURE_COLORS` object in `people-figures.js`
- Mixed mode distributes across roles by weighted probability

## Important Implementation Notes

- Source files are in `src/` folder: `main.js`, `people-figures.js`, `styles.css`
- HTML references use `/src/` prefix for script and style imports
- Matterport SDK loads via iframe, NOT npm package - no direct SDK API usage
- Export creates JSON with model SID, timestamp, all people data, and role summary
