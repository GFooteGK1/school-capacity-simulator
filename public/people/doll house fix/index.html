<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Capacity Simulator â€” Matterport Occupancy Visualizer</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/src/styles.css">
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-left">
    <div class="logo-mark">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
        <circle cx="10" cy="8" r="3.5" stroke="#E85D3A" stroke-width="1.5" fill="none"/>
        <path d="M3 18c0-3.866 3.134-7 7-7s7 3.134 7 7" stroke="#E85D3A" stroke-width="1.5" fill="none" stroke-linecap="round"/>
      </svg>
    </div>
    <div>
      <div class="header-title">School Capacity Simulator</div>
      <div class="header-sub" id="statusText">Loading Matterport scan...</div>
    </div>
  </div>
  <div class="header-right">
    <div class="occupancy-badge">
      <div class="occ-bar-track"><div class="occ-bar-fill" id="occBar"></div></div>
      <span class="occ-text" id="occText">0/25</span>
    </div>
    <button class="panel-toggle" id="panelToggle">âœ•</button>
  </div>
</header>

<div class="app-body">
  <!-- VIEWPORT -->
  <div class="viewport" id="viewport">
    <iframe id="mpIframe" allow="fullscreen; xr-spatial-tracking" allowfullscreen></iframe>

    <!-- Zone selection overlay â€” user draws a rectangle -->
    <canvas id="zoneCanvas"></canvas>

    <!-- People figures layer â€” uses percentage positioning -->
    <div class="figures-layer" id="figuresLayer"></div>

    <!-- Per-figure scale popup -->
    <div class="scale-popup" id="scalePopup" style="display:none;">
      <div class="scale-popup-row">
        <span class="scale-popup-label">Scale</span>
        <input type="range" id="scaleSlider" min="0.5" max="2.0" step="0.05" value="1.0">
        <span id="scaleValueDisplay">1.0Ã—</span>
        <button id="scaleResetBtn" title="Reset">â†º</button>
        <button id="scalePopupClose">âœ•</button>
      </div>
    </div>

    <!-- Placement banner -->
    <div class="placement-banner" id="placementBanner">
      <span class="placement-dot"></span>
      <span id="placementText">Click and drag to define the area</span>
      <button class="cancel-btn" id="cancelBtn">Cancel</button>
    </div>

    <!-- Stats bar -->
    <div class="stats-bar" id="statsBar"></div>
  </div>

  <!-- SIDE PANEL -->
  <aside class="panel" id="panel">

    <!-- LOAD SCAN -->
    <div class="section">
      <h3 class="section-title">Load Scan</h3>
      <select class="role-select-main" id="scanSelect">
        <!-- Populated dynamically from AVAILABLE_SCANS -->
      </select>
      <details style="margin-top: 12px;">
        <summary style="cursor: pointer; font-size: 12px; color: #666; margin-bottom: 8px;">Or enter custom SID</summary>
        <input class="name-input" id="modelInput" placeholder="Model SID (e.g. hvvUfPkLBME)" style="margin-bottom: 6px;">
        <button class="load-btn" id="loadModelBtn">ğŸ”„ Load Custom</button>
      </details>
    </div>

    <!-- BULK ADD -->
    <div class="section">
      <h3 class="section-title">Add People</h3>
      <div class="bulk-row">
        <input class="count-input" id="countInput" type="number" value="10" min="1" max="200" placeholder="#">
        <select class="role-select-main" id="roleSelect">
          <option value="Student">ğŸ’ Students</option>
          <option value="Teacher">ğŸ“š Teachers</option>
          <option value="Admin">ğŸ’¼ Admin</option>
          <option value="Staff">ğŸ”§ Staff</option>
          <option value="Visitor">ğŸ‘‹ Visitors</option>
          <option value="Parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parents</option>
          <option value="Custodian">ğŸ§¹ Custodians</option>
          <option value="Mixed">ğŸ² Mixed</option>
        </select>
      </div>
      <button class="place-btn" id="placeBtn">ğŸ“ Select Area & Place</button>
      <p class="hint-text">Draw a freehand shape around the area where people should go. They'll scatter naturally inside the shape you draw.</p>
    </div>

    <!-- SINGLE ADD -->
    <div class="section">
      <h3 class="section-title">Place Individual</h3>
      <div class="role-grid" id="roleGrid"></div>
      <button class="place-single-btn" id="placeSingleBtn">ğŸ‘¤ Place One Person</button>
    </div>

    <!-- CAPACITY -->
    <div class="section">
      <div class="capacity-row">
        <h3 class="section-title" style="margin-bottom:0">Capacity Limit</h3>
        <input class="limit-input" id="limitInput" type="number" value="50" min="1">
      </div>
    </div>

    <!-- FIGURE SIZE -->
    <div class="section">
      <h3 class="section-title">Figure Size</h3>
      <div class="size-row">
        <label class="size-label">Size</label>
        <input type="range" id="figureSize" min="16" max="200" value="60" class="size-slider">
        <span class="size-val" id="sizeVal">60px</span>
      </div>
      <div class="size-row" style="margin-top: 8px;">
        <label class="size-label">Perspective</label>
        <input type="range" id="perspectiveSlider" min="0" max="100" value="70" class="size-slider">
        <span class="size-val" id="perspectiveVal">70%</span>
      </div>
      <p class="hint-text">Scales figures by depth â€” closer figures appear larger. Set to 0% for flat views like dollhouse.</p>
    </div>

    <!-- PEOPLE LIST -->
    <div class="section">
      <div class="people-count-row">
        <h3 class="section-title" style="margin-bottom:0" id="peopleTitle">People (0)</h3>
        <div class="people-actions">
          <button class="icon-action-btn" id="exportBtn" title="Export JSON">ğŸ“‹</button>
          <button class="icon-action-btn danger" id="clearBtn" title="Clear All">ğŸ—‘</button>
        </div>
      </div>
      <div class="role-summary" id="roleSummary"></div>
      <div class="people-list" id="peopleList">
        <p class="empty-text">No one placed yet.</p>
      </div>
    </div>

    <div class="help-box">
      <p class="help-title">ğŸ’¡ Tips</p>
      <p class="help-text">
        â€¢ People are anchored in 3D space â€” they stay in place as you navigate<br>
        â€¢ Draw a shape to scatter people inside it<br>
        â€¢ Click a figure to adjust its individual scale<br>
        â€¢ Right-click any figure to remove it<br>
        â€¢ Set Perspective to 0% for dollhouse/floorplan views
      </p>
    </div>
  </aside>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script type="module" src="/src/people-figures.js"></script>
<script type="module" src="/src/people-photos.js"></script>
<script type="module" src="/src/main.js"></script>
</body>
</html>
